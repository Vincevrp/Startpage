window.onload=function(){const e={bodyClassAdd:t=>e.el("body").classList.add(t),bodyClassHas:t=>e.el("body").classList.contains(t),bodyClassRemove:t=>e.el("body").classList.remove(t),el:e=>document.querySelector(e),els:e=>[].slice.call(document.querySelectorAll(e)||[]),escapeRegex:e=>e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),ieq:(e,t)=>e.toLowerCase()===t.toLowerCase(),iin:(e,t)=>-1!==e.toLowerCase().indexOf(t.toLowerCase()),isDown:t=>["c-n","down","tab"].includes(e.key(t)),isRemove:t=>["backspace","delete"].includes(e.key(t)),isUp:t=>["c-p","up","s-tab"].includes(e.key(t)),jsonp:t=>{let s=document.createElement("script");s.src=t,e.el("head").appendChild(s)},key:e=>{const t=e.ctrlKey,s=e.shiftKey;switch(e.which){case 8:return"backspace";case 9:return s?"s-tab":"tab";case 13:return"enter";case 16:return"shift";case 17:return"ctrl";case 18:return"alt";case 27:return"escape";case 38:return"up";case 40:return"down";case 46:return"delete";case 78:return t?"c-n":"n";case 80:return t?"c-p":"n";case 91:return"super"}}};class t{constructor(t){this._el=e.el("#clock"),this._delimiter=t.delimiter,this._form=t.form,this._setTime=this._setTime.bind(this),this._registerEvents(),this._start()}_pad(e){return("0"+e.toString()).slice(-2)}_registerEvents(){this._el.addEventListener("click",this._form.show)}_setTime(){const e=new Date,t=this._pad(e.getHours()),s=this._pad(e.getMinutes());this._el.innerHTML=t+this._delimiter+s}_start(){this._setTime(),setInterval(this._setTime,1e3)}}class s{constructor(t){this._el=e.el("#help"),this._commands=t.commands,this._newTab=t.newTab,this._toggled=!1,this._buildAndAppendLists(),this._bindMethods(),this._registerEvents()}toggle(t){this._toggled=void 0!==t?t:!this._toggled,this._toggled?e.bodyClassAdd("help"):e.bodyClassRemove("help")}_bindMethods(){this._handleKeydown=this._handleKeydown.bind(this)}_buildAndAppendLists(){const e=document.createElement("ul");e.classList.add("categories"),this._getCategories().forEach(t=>{e.insertAdjacentHTML("beforeend",`<li class="category">\n          <h2 class="category-name">${t}</h2>\n          <ul>${this._buildListCommands(t)}</ul>\n        </li>`)}),this._el.appendChild(e)}_buildListCommands(e){return this._commands.map(([t,s,i,r])=>{if(t===e)return`<li class="command">\n            <a href="${r}" target="${this._newTab?"_blank":"_self"}">\n              <span class="command-key">${i}</span>\n              <span class="command-name">${s}</span>\n            </a>\n          </li>`}).join("")}_getCategories(){const e=this._commands.map(([e])=>e).filter(e=>e);return[...new Set(e)]}_handleKeydown(t){"escape"===e.key(t)&&this.toggle(!1)}_registerEvents(){document.addEventListener("keydown",this._handleKeydown)}}class i{constructor(e){this._limit=e.limit,this._queryParser=e.queryParser}addItem(){}getSuggestions(){}_addSearchPrefix(e,t){const s=this._getSearchPrefix(t);return e.map(e=>s?s+e:e)}_getSearchPrefix(e){const{isSearch:t,key:s,split:i}=this._parseQuery(e);return!!t&&`${s}${i} `}_parseQuery(e){return this._queryParser.parse(e)}}class r extends i{constructor({defaultSuggestions:e}){super(...arguments),this._defaultSuggestions=e}getSuggestions(e){return new Promise(t=>{const s=this._defaultSuggestions[e];t(s?s.slice(0,this._limit):[])})}}class n extends i{constructor({queryParser:e}){super(...arguments)}getSuggestions(t){const{query:s}=this._parseQuery(t);return s?new Promise(i=>{window.autocompleteCallback=(r=>{const n=r.map(e=>e.phrase).filter(t=>!e.ieq(t,s)).slice(0,this._limit);i(this._addSearchPrefix(n,t))}),e.jsonp(`https://duckduckgo.com/ac/?callback=autocompleteCallback&q=${s}`)}):Promise.resolve([])}}class h extends i{constructor(){super(...arguments),this._storeName="history"}addItem(t){if(t.length<2)return;let s;const i=this._getHistory().map(([i,r])=>{const n=e.ieq(i,t);return n&&(s=!0),[i,n?r+1:r]});s||i.push([t,1]),this._setHistory(this._sort(i))}getSuggestions(e){return new Promise(t=>{t(this._getHistory().map(([e])=>e).filter(t=>this._itemContainsQuery(e,t)).slice(0,this._limit))})}_fetch(){return JSON.parse(localStorage.getItem(this._storeName))||[]}_getHistory(){return this._history=this._history||this._fetch(),this._history}_itemContainsQuery(t,s){return t&&!e.ieq(s,t)&&e.iin(s,t)}_save(e){localStorage.setItem(this._storeName,JSON.stringify(e))}_setHistory(e){this._history=e,this._save(e)}_sort(e){return e.sort((e,t)=>e[1]-t[1]).reverse()}}class a{constructor(t){this._el=e.el("#search-suggestions"),this._influencers=t.influencers,this._limit=t.limit,this._suggestionEls=[],this._bindMethods(),this._registerEvents()}setOnClick(e){this._onClick=e}setOnHighlight(e){this._onHighlight=e}setOnUnhighlight(e){this._onUnhighlight=e}success(e){this._clearSuggestions(),this._influencers.forEach(t=>t.addItem(e))}suggest(t){""===(t=t.trim())&&this._clearSuggestions(),Promise.all(this._getInfluencerPromises(t)).then(s=>{const i=this._flattenAndUnique(s);this._clearSuggestions(),i.length&&(this._appendSuggestions(i,t),this._registerSuggestionEvents(),e.bodyClassAdd("suggestions"))})}_appendSuggestions(t,s){t.some((t,i)=>{const r=new RegExp(e.escapeRegex(s),"ig"),n=t.replace(r,`<b>${s}</b>`);return this._el.insertAdjacentHTML("beforeend",`<li>\n          <button\n            type="button"\n            class="js-search-suggestion search-suggestion"\n            data-suggestion="${t}"\n            tabindex="-1"\n          >\n            ${n}\n          </button>\n        </li>`),i+1>=this._limit}),this._suggestionEls=e.els(".js-search-suggestion")}_bindMethods(){this._handleKeydown=this._handleKeydown.bind(this)}_clearClickEvents(){this._suggestionEls.forEach(e=>{const t=this._onClick.bind(null,e.value);e.removeEventListener("click",t)})}_clearSuggestions(){e.bodyClassRemove("suggestions"),this._clearClickEvents(),this._suggestionEls=[],this._el.innerHTML=""}_flattenAndUnique(e){return[...new Set([].concat.apply([],e))]}_focusNext(e){this._suggestionEls.some((t,s)=>{if(t.classList.contains("highlight"))return this._highlight(this._suggestionEls[s+1],e),!0})||this._highlight(this._suggestionEls[0],e)}_focusPrevious(e){this._suggestionEls.some((t,s)=>{if(t.classList.contains("highlight")&&s)return this._highlight(this._suggestionEls[s-1],e),!0})||this._unHighlight(e)}_getInfluencerPromises(e){return this._influencers.map(t=>t.getSuggestions(e))}_handleKeydown(t){e.isDown(t)&&this._focusNext(t),e.isUp(t)&&this._focusPrevious(t)}_highlight(e,t){this._unHighlight(),e&&(this._onHighlight(e.getAttribute("data-suggestion")),e.classList.add("highlight"),t.preventDefault())}_registerEvents(){document.addEventListener("keydown",this._handleKeydown)}_registerSuggestionEvents(){this._suggestionEls.forEach(e=>{const t=e.getAttribute("data-suggestion");e.addEventListener("mouseover",this._highlight.bind(this,e)),e.addEventListener("mouseout",this._unHighlight.bind(this)),e.addEventListener("click",this._onClick.bind(null,t))})}_unHighlight(t){const s=e.el(".highlight");s&&(this._onUnhighlight(),s.classList.remove("highlight"),t&&t.preventDefault())}}class o{constructor(e){this._commands=e.commands,this._searchDelimiter=e.searchDelimiter,this._pathDelimiter=e.pathDelimiter,this._protocolRegex=/^[a-zA-Z]+:\/\//i,this._urlRegex=/^((https?:\/\/)?[\w-]+(\.[\w-]+)+\.?(:\d+)?(\/\S*)?)$/i}parse(e){const t={query:e,split:null};if(e.match(this._urlRegex)){const s=e.match(this._protocolRegex);t.redirect=s?e:"http://"+e}else{const s=e.split(this._searchDelimiter),i=e.split(this._pathDelimiter);this._commands.some(([r,n,h,a,o])=>{if(t.isKey=e===h,t.isSearch=!t.isKey&&s[0]===h,t.isPath=!t.isKey&&i[0]===h,t.isKey||t.isSearch||t.isPath)return t.key=h,t.isSearch&&o?(t.split=this._searchDelimiter,t.query=this._shiftAndTrim(s,t.split),t.redirect=this._prepSearch(a,o,t.query)):t.isPath?(t.split=this._pathDelimiter,t.path=this._shiftAndTrim(i,t.split),t.redirect=this._prepPath(a,t.path)):t.redirect=a,!0;"*"===h&&(t.redirect=this._prepSearch(a,o,e))})}return t.color=this._getColorFromUrl(t.redirect),t}_getColorFromUrl(e){const t=this._getHostname(e);return this._commands.filter(e=>this._getHostname(e[3])===t).map(e=>e[5])[0]||null}_getHostname(e){const t=document.createElement("a");return t.href=e,t.hostname.replace(/^www./,"")}_prepPath(e,t){return this._stripUrlPath(e)+"/"+t}_prepSearch(e,t,s){if(!t)return e;const i=this._stripUrlPath(e),r=encodeURIComponent(s);return t=t.replace("{}",r),i+t}_shiftAndTrim(e,t){return e.shift(),e.join(t).trim()}_stripUrlPath(e){const t=document.createElement("a");return t.href=e,`${t.protocol}//${t.hostname}`}}class l{constructor(t){this._formEl=e.el("#search-form"),this._inputEl=e.el("#search-input"),this._colors=t.colors,this._help=t.help,this._suggester=t.suggester,this._queryParser=t.queryParser,this._instantRedirect=t.instantRedirect,this._newTab=t.newTab,this._inputElVal="",this._bindMethods(),this._registerEvents(),this._loadQueryParam()}hide(){e.bodyClassRemove("form"),this._inputEl.value="",this._inputElVal=""}show(){e.bodyClassAdd("form"),this._inputEl.focus()}_bindMethods(){this.hide=this.hide.bind(this),this.show=this.show.bind(this),this._clearPreview=this._clearPreview.bind(this),this._handleKeydown=this._handleKeydown.bind(this),this._handleInput=this._handleInput.bind(this),this._previewValue=this._previewValue.bind(this),this._submitForm=this._submitForm.bind(this),this._submitWithValue=this._submitWithValue.bind(this)}_clearPreview(){this._previewValue(this._inputElVal),this._inputEl.focus()}_handleKeydown(t){if(!(e.isUp(t)||e.isDown(t)||e.isRemove(t))){switch(e.key(t)){case"alt":case"ctrl":case"enter":return void(""===this._inputEl.value&&this._help.toggle());case"shift":case"super":return;case"escape":return void this.hide()}this.show()}}_handleInput(){const e=this._inputEl.value,t="?"===e,{isKey:s}=this._queryParser.parse(e);this._inputElVal=e,this._setBackgroundFromQuery(e),e&&!t||this.hide(),t&&this._help.toggle(),this._instantRedirect&&s&&this._submitWithValue(e),this._suggester&&this._suggester.suggest(e)}_loadQueryParam(){const e=new URLSearchParams(window.location.search).get("q");e&&this._submitWithValue(e)}_previewValue(e){this._inputEl.value=e,this._setBackgroundFromQuery(e)}_redirect(e){this._newTab?window.open(e,"_blank"):window.location.href=e}_registerEvents(){document.addEventListener("keydown",this._handleKeydown),this._inputEl.addEventListener("input",this._handleInput),this._formEl.addEventListener("submit",this._submitForm,!1),this._suggester&&(this._suggester.setOnClick(this._submitWithValue),this._suggester.setOnHighlight(this._previewValue),this._suggester.setOnUnhighlight(this._clearPreview))}_setBackgroundFromQuery(e){if(!this._colors)return;const{color:t}=this._queryParser.parse(e);this._formEl.style.backgroundColor=t}_submitForm(e){e&&e.preventDefault();const t=this._inputEl.value;this._suggester&&this._suggester.success(t),this.hide(),this._redirect(this._queryParser.parse(t).redirect)}_submitWithValue(e){this._inputEl.value=e,this._submitForm()}}!function(){const e=()=>new s({commands:CONFIG.commands,newTab:CONFIG.newTab}),i=()=>{const e={Default:r,DuckDuckGo:n,History:h};return CONFIG.influencers.map(t=>new e[t.name]({limit:t.limit,queryParser:u(),defaultSuggestions:CONFIG.defaultSuggestions}))},c=()=>new a({influencers:i(),limit:CONFIG.suggestionsLimit}),u=()=>new o({commands:CONFIG.commands,pathDelimiter:CONFIG.pathDelimiter,searchDelimiter:CONFIG.searchDelimiter});new t({delimiter:CONFIG.clockDelimiter,form:new l({colors:CONFIG.colors,help:e(),instantRedirect:CONFIG.instantRedirect,newTab:CONFIG.newTab,queryParser:u(),suggester:!!CONFIG.suggestions&&c()})})}()}();